# =============================================================================
# OpInf Pipeline Configuration
# =============================================================================
# This configuration file controls all parameters for the discrete-time
# Operator Inference ROM pipeline.
#
# Usage:
#   mpirun -np 4 python step_1_preprocess.py --config config.yaml
#   mpirun -np 4 python step_2_train.py --config config.yaml --run-dir /path
#   python step_3_evaluate.py --config config.yaml --run-dir /path
# =============================================================================

run_name: "example"

# =============================================================================
# DATA PATHS
# =============================================================================
paths:
  output_base: "/scratch/user/output/"       # Base directory for outputs
  data_dir: "/scratch/user/data/hw2d/"       # Directory containing HDF5 files
  
  training_files:
    - simulation_001.h5
  
  test_files:
    - simulation_002.h5
    - simulation_003.h5

# =============================================================================
# PHYSICS PARAMETERS
# =============================================================================
physics:
  dt: 0.025              # Simulation time step
  n_fields: 2            # Number of fields (e.g., density, phi)
  n_x: 256               # Grid points in x
  n_y: 256               # Grid points in y

# =============================================================================
# TRAINING MODE
# =============================================================================
# Two modes available:
#   "multi_trajectory" - Train on full trajectories, test on different ICs (default)
#   "temporal_split"   - Train/test on specified snapshot ranges from one trajectory
# =============================================================================
training_mode:
  mode: "multi_trajectory"
  # Only used if mode="temporal_split":
  train_start: 8000      # Train from this snapshot
  train_end: 16000       # Train to this snapshot
  test_start: 16000      # Test from this snapshot
  test_end: 24000        # Test to this snapshot

# =============================================================================
# DIMENSIONALITY REDUCTION
# =============================================================================
# Two methods available:
#   "linear"   - Standard POD (default)
#   "manifold" - Quadratic manifold via greedy mode selection
# =============================================================================
reduction:
  method: "linear"       # "linear" or "manifold"
  r: 75                  # Number of modes to retain
  target_energy: 0.9999  # Alternative to fixed r (uses whichever is smaller)
  
  # Quadratic manifold settings (only used if method="manifold")
  n_vectors_to_check: 200  # Max candidates per greedy step
  reg_magnitude: 1.0e-6    # Tikhonov regularization for coefficient solve
  
  # Manifold-aware training (only used if method="manifold")
  # These settings help the ROM operators respect the manifold structure
  manifold_aware_training: true  # Use manifold consistency loss in training
  manifold_consistency_weight: 1.0  # Weight for full-space consistency loss
  manifold_reencode_output: true   # Decode→re-encode before computing output

# =============================================================================
# DATA TRUNCATION
# =============================================================================
truncation:
  enabled: true          # Enable time truncation of trajectories
  method: "time"         # "time" (seconds) or "snapshots" (count)
  time: 200.0            # Truncate to this simulation time
  snapshots: null        # Or truncate to this many snapshots

# =============================================================================
# PREPROCESSING
# =============================================================================
preprocessing:
  centering: true        # Subtract temporal mean (RECOMMENDED for POD)
  scaling: false         # Normalize each field to [-1, 1]

# =============================================================================
# TRAINING PARAMETERS
# =============================================================================
training:
  training_end: 8000     # Index marking end of training region (for error calc)
  n_steps: 8000          # Number of time steps for ROM integration

# =============================================================================
# REGULARIZATION PARAMETER GRIDS
# =============================================================================
# The OpInf optimization uses Tikhonov regularization:
#   min ||D @ O - Y||_F^2 + α_lin ||O_lin||_F^2 + α_quad ||O_quad||_F^2
#
# The grid search explores all combinations of these parameters.
# Total combinations = num(state_lin) × num(state_quad) × num(output_lin) × num(output_quad)
# =============================================================================
regularization:
  state_lin:
    min: 1.0e0
    max: 1.0e7
    num: 10
    scale: "log"         # "linear" or "log"
  
  state_quad:
    min: 1.0e4
    max: 1.0e12
    num: 10
    scale: "log"
  
  output_lin:
    min: 1.0e-2
    max: 1.0e4
    num: 10
    scale: "log"
  
  output_quad:
    min: 1.0e-2
    max: 1.0e6
    num: 10
    scale: "log"

# =============================================================================
# MODEL SELECTION
# =============================================================================
# After hyperparameter sweep, models meeting BOTH threshold criteria are kept.
# All four error metrics (mean_n, std_n, mean_c, std_c) must be below thresholds.
# =============================================================================
model_selection:
  threshold_mean: 0.05   # Max 5% error in mean statistics
  threshold_std: 0.20    # Max 20% error in std statistics

# =============================================================================
# EVALUATION OPTIONS
# =============================================================================
evaluation:
  save_predictions: true   # Save ensemble predictions to disk
  generate_plots: true     # Generate Gamma diagnostic plots
  plot_state_error: false  # Generate L2 state error over time plots
  plot_state_snapshots: false  # Generate 2D snapshot comparison plots
  n_snapshot_samples: 5    # Number of snapshots for comparison

# =============================================================================
# EXECUTION OPTIONS
# =============================================================================
execution:
  verbose: true          # Print progress information
  log_level: "INFO"      # DEBUG, INFO, WARNING, ERROR
  engine: "h5netcdf"     # HDF5 engine for xarray
